name: build
on:
  push:
    branches-ignore:
      - "github-actions/**" # ignore github-actions branches
      - "dependabot/**" # ignore dependabot branches
  pull_request: # any pull request against any branch
  workflow_dispatch: # manual trigger
    inputs:
      triggered_by:
        description: 'Repository that triggered this build'
        required: false
        default: 'manual'
      commit_sha:
        description: 'Commit SHA from triggering repo'
        required: false
        default: 'N/A'
      commit_message:
        description: 'Commit message from triggering repo'
        required: false
        default: 'N/A'
  schedule:
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)
    # â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)
    # â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the month (1 - 31)
    # â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12 or JAN-DEC)
    # â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the week (0 - 6 or SUN-SAT)
    # â”‚ â”‚ â”‚ â”‚ â”‚
    # * * * * *
    - cron: "30 14 * * *" # every day at 14:30 UTC (6:30 PST, 7:30 PDT)

env:
  TERM: xterm-256color
  DEVELOPER_DIR: /Applications/Xcode_${{ vars.XCODE_VERSION }}.app/Contents/Developer

jobs:
  build:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        build-target: [frameworks, apps, tools]
    timeout-minutes: 30
    runs-on: ${{ vars.MACOS }}
    steps:
      - name: Display trigger information
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ”” Build triggered by: ${{ github.event.inputs.triggered_by }}"
          echo "ğŸ“ Commit SHA: ${{ github.event.inputs.commit_sha }}"
          echo "ğŸ’¬ Commit message: ${{ github.event.inputs.commit_message }}"

      - name: Check out current repository
        uses: actions/checkout@v4
          
      - name: Bootstrap
        uses: ./.github/actions/bootstrap
        with:
          personal-access-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          artifacts-s3-endpoint: ${{ secrets.ARTIFACTS_S3_ENDPOINT }}
          artifacts-s3-access-key-id: ${{ secrets.ARTIFACTS_S3_ACCESS_KEY_ID }}
          artifacts-s3-secret-access-key: ${{ secrets.ARTIFACTS_S3_SECRET_ACCESS_KEY }}

      - name: Build
        run: |
          cd $BLUEBOX_DIR
          make build-${{ matrix.build-target }}
