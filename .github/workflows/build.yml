name: build
on:
  workflow_dispatch: # manual trigger
    inputs:
      triggered_by:
        description: 'Repository that triggered this build'
        required: false
        default: 'manual'
      commit_sha:
        description: 'Commit SHA from triggering repo'
        required: false
        default: 'N/A'
      commit_message:
        description: 'Commit message from triggering repo'
        required: false
        default: 'N/A'

env:
  TERM: xterm-256color
  DEVELOPER_DIR: /Applications/Xcode_${{ vars.XCODE_VERSION }}.app/Contents/Developer

jobs:
  build:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        build-target: [
          packages/ChouTiExt,
          packages/ChouTiUIExt,
          packages/ChouTiSwiftUI,
          packages/ChouTiRx,
          packages/ChouTiArchive,
          packages/DataAccess,
          packages/RemoteAccess,
          packages/AppStore,
          packages/Files,
          packages/CLI,
          apps/wazer,
          apps/say-no-to-notch,
          apps/aqua-menu-bar,
          apps/git-streaks,
          apps/menubar-ip,
          apps/rive-play,
          tools/artifact,
          tools/avcut,
          tools/git2,
          tools/startup,
          tools/zsh2,
        ]
    timeout-minutes: 30
    runs-on: ${{ vars.MACOS }}
    steps:
      - name: Display trigger information
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ”” Build triggered by: ${{ github.event.inputs.triggered_by }}"
          echo "ðŸ“ Commit SHA: ${{ github.event.inputs.commit_sha }}"
          echo "ðŸ’¬ Commit message: ${{ github.event.inputs.commit_message }}"

      - name: Check out current repository
        uses: actions/checkout@v4
          
      - name: Bootstrap
        uses: ./.github/actions/bootstrap
        with:
          personal-access-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          artifacts-s3-endpoint: ${{ secrets.ARTIFACTS_S3_ENDPOINT }}
          artifacts-s3-access-key-id: ${{ secrets.ARTIFACTS_S3_ACCESS_KEY_ID }}
          artifacts-s3-secret-access-key: ${{ secrets.ARTIFACTS_S3_SECRET_ACCESS_KEY }}

      - name: Generate cache key
        id: cache-key
        run: |
          if [[ "${{ matrix.build-target }}" == packages/* ]] || [[ "${{ matrix.build-target }}" == tools/* ]]; then
            # For SPM packages: use Package.resolved
            if [ -f "bluebox/${{ matrix.build-target }}/Package.resolved" ]; then
              HASH=$(cat "bluebox/${{ matrix.build-target }}/Package.resolved" | sha256sum | cut -d' ' -f1)
            else
              # Fallback to Package.swift if Package.resolved doesn't exist
              HASH=$(cat "bluebox/${{ matrix.build-target }}/Package.swift" | sha256sum | cut -d' ' -f1)
            fi
            echo "spm-package-cache-hash=$HASH" >> $GITHUB_OUTPUT
            echo "Generated SPM package cache hash: $HASH"
          fi

      - name: Restore SPM package build cache
        uses: actions/cache@v4
        id: spm-package-build-cache
        if: startsWith(matrix.build-target, 'packages/') || startsWith(matrix.build-target, 'tools/')
        with:
          path: |
            bluebox/${{ matrix.build-target }}/.build
          key: ${{ runner.os }}-${{ matrix.build-target }}-spm-package-build-${{ steps.cache-key.outputs.spm-package-cache-hash }}
          restore-keys: ${{ runner.os }}-${{ matrix.build-target }}-spm-package-build-

      - name: Restore Xcode derived data cache
        uses: actions/cache@v4
        id: xcode-derived-data-cache
        if: startsWith(matrix.build-target, 'apps/')
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            !~/Library/Developer/Xcode/DerivedData/**/ModuleCache.noindex
          key: ${{ runner.os }}-${{ matrix.build-target }}-xcode-derived-data-${{ vars.XCODE_VERSION }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.build-target }}-xcode-derived-data-${{ vars.XCODE_VERSION }}

      - name: Build
        run: |
          cd $BLUEBOX_DIR
          make build -C ${{ matrix.build-target }}
